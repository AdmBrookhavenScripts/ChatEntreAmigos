if getgenv()._Chat then
	return
end
getgenv()._Chat = true
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local StarterGui = game:GetService("StarterGui")
local HttpService = game:GetService("HttpService")
local Http = request or http_request or syn.request

local ScreenGui = Instance.new("ScreenGui", PlayerGui)
ScreenGui.Name = "ChatFriends"
ScreenGui.ResetOnSpawn = false

local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.Size = UDim2.new(0, 420, 0, 260)
MainFrame.Position = UDim2.new(0.5, -210, 0.5, -130)
MainFrame.BackgroundColor3 = Color3.fromRGB(25,25,25)
MainFrame.BackgroundTransparency = 0.2
MainFrame.BorderSizePixel = 0
MainFrame.Visible = false
MainFrame.Active = true
MainFrame.Draggable = true
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0,10)

local MinButton = Instance.new("ImageButton", ScreenGui)
MinButton.Size = UDim2.new(0,40,0,40)
MinButton.Position = UDim2.new(0.500000, -393, 0.500000, -139)
MinButton.BackgroundTransparency = 1
MinButton.Image = "rbxassetid://89187866469033"
MinButton.Active = true
MinButton.Draggable = true

local minimized = true
MinButton.MouseButton1Click:Connect(function()
	minimized = not minimized
	MainFrame.Visible = not minimized
end)

local TweenService = game:GetService("TweenService")

local SendingIcon = Instance.new("ImageLabel", MainFrame)
SendingIcon.Size = UDim2.new(0,25,0,25)
SendingIcon.Position = UDim2.new(1,-28,0,10)
SendingIcon.BackgroundTransparency = 1
SendingIcon.Image = "rbxassetid://91631338751406"
SendingIcon.Visible = false

local TitleBar = Instance.new("TextLabel", MainFrame)
TitleBar.Size = UDim2.new(1, -20, 0, 28)
TitleBar.Position = UDim2.new(0, 10, 0, 6)
TitleBar.Text = "Chat entre amigos (roblox)"
TitleBar.Font = Enum.Font.GothamBold
TitleBar.TextSize = 14
TitleBar.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleBar.BackgroundTransparency = 1
TitleBar.TextXAlignment = Enum.TextXAlignment.Left

local ChatArea = Instance.new("ScrollingFrame", MainFrame)
ChatArea.Position = UDim2.new(0,10,0,40)
ChatArea.Size = UDim2.new(1,-20,1,-95)
ChatArea.CanvasSize = UDim2.new(0,0,0,0)
ChatArea.AutomaticCanvasSize = Enum.AutomaticSize.Y
ChatArea.ScrollBarImageTransparency = 1
ChatArea.BorderSizePixel = 0
ChatArea.BackgroundTransparency = 1
ChatArea.ScrollingDirection = Enum.ScrollingDirection.Y

local Layout = Instance.new("UIListLayout", ChatArea)
Layout.Padding = UDim.new(0,6)
Layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
	ChatArea.CanvasPosition = Vector2.new(
		0,
		math.max(0, Layout.AbsoluteContentSize.Y - ChatArea.AbsoluteWindowSize.Y)
	)
end)

local InputBox = Instance.new("TextBox", MainFrame)
InputBox.Position = UDim2.new(0,10,1,-42)
InputBox.Size = UDim2.new(1,-75,0,30)
InputBox.PlaceholderText = "Digite uma mensagem aqui"
InputBox.Text = ""
InputBox.TextColor3 = Color3.new(1,1,1)
InputBox.ClearTextOnFocus = false
InputBox.BackgroundColor3 = Color3.fromRGB(30,30,30)
InputBox.BorderSizePixel = 0
InputBox.TextSize = 13
InputBox.TextWrapped = true
Instance.new("UICorner", InputBox).CornerRadius = UDim.new(0,8)

local sending = false
local rotateTween

local function startSendingAnimation()
	if sending then return end
	sending = true
	SendingIcon.Visible = true

	rotateTween = TweenService:Create(
		SendingIcon,
		TweenInfo.new(
			0.8,
			Enum.EasingStyle.Linear,
			Enum.EasingDirection.In,
			-1
		),
		{ Rotation = 360 }
	)

	rotateTween:Play()
end

local function stopSendingAnimation()
	sending = false
	if rotateTween then
		rotateTween:Cancel()
	end
	SendingIcon.Rotation = 0
	SendingIcon.Visible = false
end

local SendButton = Instance.new("ImageButton", MainFrame)
SendButton.Position = UDim2.new(1,-55,1,-42)
SendButton.Size = UDim2.new(0,30,0,30)
SendButton.BackgroundTransparency = 1
SendButton.Image = "rbxassetid://94352710651660"

local function notifyExternal(name, message, thumbnail)
	if not minimized then return end
	pcall(function()
		StarterGui:SetCore("SendNotification", {
			Title = name,
			Text = message,
			Icon = thumbnail,
			Duration = 5
		})
	end)
end

local function parseRichText(text)
	text = text:gsub("%*%*(.-)%*%*", "<b>%1</b>")
	text = text:gsub("(@[%w_]+)", "<font color=\"rgb(0,170,255)\">%1</font>")
	return text
end

local function createExternalMessage(name, message, thumbnail)
	notifyExternal(name, message, thumbnail)

    local MessageFrame = Instance.new("Frame", ChatArea)
MessageFrame.Size = UDim2.new(1,-10,0,0)
MessageFrame.BackgroundColor3 = Color3.fromRGB(30,30,30)
MessageFrame.BorderSizePixel = 0
MessageFrame.AutomaticSize = Enum.AutomaticSize.Y
Instance.new("UICorner", MessageFrame).CornerRadius = UDim.new(0,8)

task.delay(165, function()
	if MessageFrame and MessageFrame.Parent then
		MessageFrame:Destroy()
	end
end)

	local Avatar = Instance.new("ImageLabel", MessageFrame)
	Avatar.Size = UDim2.new(0,36,0,36)
	Avatar.Position = UDim2.new(0,7,0,7)
	Avatar.BackgroundTransparency = 1
	Avatar.Image = thumbnail or ""

	local NameButton = Instance.new("TextButton", MessageFrame)
NameButton.Position = UDim2.new(0,50,0,5)
NameButton.Size = UDim2.new(1,-58,0,14)
NameButton.Text = name
NameButton.BackgroundTransparency = 1
NameButton.TextColor3 = Color3.fromRGB(255,255,255)
NameButton.Font = Enum.Font.GothamBold
NameButton.TextSize = 14
NameButton.TextXAlignment = Enum.TextXAlignment.Left
NameButton.AutoButtonColor = false

NameButton.MouseButton1Click:Connect(function()
	local mention = " @" .. name .. " "
	InputBox:CaptureFocus()

	if InputBox.Text == "" then
		InputBox.Text = mention
	else
		InputBox.Text = InputBox.Text .. mention
	end

	InputBox.CursorPosition = #InputBox.Text + 1
end)

	local MessageLabel = Instance.new("TextLabel", MessageFrame)
	MessageLabel.Position = UDim2.new(0,50,0,22)
	MessageLabel.Size = UDim2.new(1,-58,0,0)
	MessageLabel.Text = parseRichText(message)
	MessageLabel.TextWrapped = true
	MessageLabel.BackgroundTransparency = 1
	MessageLabel.TextColor3 = Color3.new(1,1,1)
	MessageLabel.Font = Enum.Font.Gotham
	MessageLabel.TextSize = 16
	MessageLabel.AutomaticSize = Enum.AutomaticSize.Y
	MessageLabel.TextXAlignment = Enum.TextXAlignment.Left
	MessageLabel.TextYAlignment = Enum.TextYAlignment.Top
	MessageLabel.RichText = true

	task.defer(function()
		MessageFrame.Size = UDim2.new(1,-10,0,math.max(Avatar.AbsoluteSize.Y + 14, MessageLabel.AbsoluteSize.Y + 30))
	end)
end

local function sendMessage(text)
	local thumb
	pcall(function()
		thumb = Players:GetUserThumbnailAsync(LocalPlayer.UserId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size150x150)
	end)

	Http({
		Url = "https://eita7.vercel.app/api/chat.js",
		Method = "POST",
		Headers = { ["Content-Type"] = "application/json" },
		Body = HttpService:JSONEncode({
			name = LocalPlayer.Name,
			thumbnail = thumb,
			message = text
		})
	})
end

SendButton.MouseButton1Click:Connect(function()
	if InputBox.Text == "" then return end
	startSendingAnimation()
	local text = InputBox.Text
	InputBox.Text = ""
	task.spawn(function()
	    sendMessage(text)
		stopSendingAnimation()
	end)
end)

local lastTime = 0

local init = Http({
	Url = "https://eita7.vercel.app/api/chat.js",
	Method = "GET"
})

if init and init.Body then
	local data = HttpService:JSONDecode(init.Body)
	for _, msg in ipairs(data) do
		if msg.time and msg.time > lastTime then
			lastTime = msg.time
		end
	end
end

task.spawn(function()
	while true do
		local res = Http({
			Url = "https://eita7.vercel.app/api/chat.js",
			Method = "GET"
		})

		if res and res.Body then
			local data = HttpService:JSONDecode(res.Body)
			for _, msg in ipairs(data) do
				if msg.time > lastTime then
					lastTime = msg.time
					createExternalMessage(msg.name, msg.message, msg.thumbnail)
				end
			end
		end
		task.wait(1.5)
	end
end)