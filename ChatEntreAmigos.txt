if getgenv()._Chat then
	return
end
getgenv()._Chat = true
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local StarterGui = game:GetService("StarterGui")
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")
local function parseRichText(text)
	text = text:gsub("%*%*(.-)%*%*", "<b>%1</b>")
	text = text:gsub("(@[%w_]+)", "<b><font color=\"rgb(0,170,255)\">%1</font></b>")
	return text
end
local MarketplaceService = game:GetService("MarketplaceService")

local FALLBACK_STICKER = "rbxassetid://74943353961959"

local function assetExists(assetId)
	local success = pcall(function()
		MarketplaceService:GetProductInfo(assetId)
	end)
	return success
end

local function setSafeImage(guiObject, assetId)
	if not guiObject then return end

	if assetExists(assetId) then
		guiObject.Image = "rbxassetid://" .. assetId
	else
		guiObject.Image = FALLBACK_STICKER
	end
end
local ScreenGui = Instance.new("ScreenGui", PlayerGui)
ScreenGui.Name = "ChatFriends"
ScreenGui.ResetOnSpawn = false
local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 450, 0, 260)
MainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
MainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
MainFrame.BackgroundColor3 = Color3.fromRGB(25,25,25)
MainFrame.BackgroundTransparency = 0.2
MainFrame.BorderSizePixel = 0
MainFrame.Visible = false
MainFrame.Active = true
MainFrame.Draggable = true
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 10)
local MinButton = Instance.new("ImageButton", ScreenGui)
MinButton.Size = UDim2.new(0,75,0,75)
MinButton.Position = UDim2.new(0.500000, -393, 0.500000, -139)
MinButton.BackgroundTransparency = 1
MinButton.Image = "rbxassetid://109930881463220"
MinButton.Active = true
MinButton.Draggable = true
local minimized = true

MinButton.MouseButton1Click:Connect(function()
	minimized = not minimized
	MainFrame.Visible = not minimized
end)

local SendingIcon = Instance.new("ImageLabel", MainFrame)
SendingIcon.Size = UDim2.new(0,25,0,25)
SendingIcon.Position = UDim2.new(1,-28,0,10)
SendingIcon.BackgroundTransparency = 1
SendingIcon.Image = "rbxassetid://91631338751406"
SendingIcon.Visible = false

local TitleBar = Instance.new("TextLabel", MainFrame)
TitleBar.Size = UDim2.new(1, -20, 0, 28)
TitleBar.Position = UDim2.new(0, 10, 0, 6)
TitleBar.Text = "Chat entre amigos (roblox)"
TitleBar.Font = Enum.Font.GothamBold
TitleBar.TextSize = 16
TitleBar.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleBar.BackgroundTransparency = 1
TitleBar.TextXAlignment = Enum.TextXAlignment.Left

local ChatArea = Instance.new("ScrollingFrame", MainFrame)
ChatArea.Position = UDim2.new(0, 0, 0, 40)
ChatArea.Size = UDim2.new(1, 0, 1, -95)
ChatArea.AutomaticCanvasSize = Enum.AutomaticSize.Y
ChatArea.CanvasSize = UDim2.new(0, 0, 0, 0)

ChatArea.ScrollBarThickness = 0
ChatArea.BorderSizePixel = 0
ChatArea.BackgroundTransparency = 1
ChatArea.ScrollingDirection = Enum.ScrollingDirection.Y
ChatArea.ElasticBehavior = Enum.ElasticBehavior.Never

local Padding = Instance.new("UIPadding", ChatArea)
Padding.PaddingLeft = UDim.new(0, 10)
Padding.PaddingRight = UDim.new(0, 6)

local Layout = Instance.new("UIListLayout", ChatArea)
Layout.Padding = UDim.new(0, 6)

Layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
	ChatArea.CanvasPosition = Vector2.new(
		0,
		math.max(0, Layout.AbsoluteContentSize.Y - ChatArea.AbsoluteWindowSize.Y)
	)
end)

local InputBox = Instance.new("TextBox", MainFrame)
InputBox.Position = UDim2.new(0,10,1,-42)
InputBox.Size = UDim2.new(1,-110,0,30)
InputBox.PlaceholderText = "Digite uma mensagem aqui"
InputBox.Text = ""
InputBox.TextColor3 = Color3.new(1,1,1)
InputBox.ClearTextOnFocus = false
InputBox.BackgroundColor3 = Color3.fromRGB(30,30,30)
InputBox.BorderSizePixel = 0
InputBox.TextSize = 13
InputBox.TextWrapped = true
Instance.new("UICorner", InputBox).CornerRadius = UDim.new(0,8)

local sending = false
local rotateTween

local function startSendingAnimation()
	if sending then return end
	sending = true
	SendingIcon.Visible = true
	rotateTween = TweenService:Create(SendingIcon, TweenInfo.new(0.8, Enum.EasingStyle.Linear, Enum.EasingDirection.In, -1), {Rotation = 360})
	rotateTween:Play()
end

local function stopSendingAnimation()
	sending = false
	if rotateTween then rotateTween:Cancel() end
	SendingIcon.Rotation = 0
	SendingIcon.Visible = false
end

local StickerButton = Instance.new("ImageButton", MainFrame)
StickerButton.Size = UDim2.new(0,30,0,30)
StickerButton.Position = UDim2.new(1,-95,1,-42)
StickerButton.BackgroundTransparency = 1
StickerButton.Image = "rbxassetid://76929804268592"

local SendButton = Instance.new("ImageButton", MainFrame)
SendButton.Position = UDim2.new(1,-55,1,-42)
SendButton.Size = UDim2.new(0,30,0,30)
SendButton.BackgroundTransparency = 1
SendButton.Image = "rbxassetid://94352710651660"

local StickerFrame = Instance.new("Frame", MainFrame)
StickerFrame.Position = UDim2.new(1,6,0,0)
StickerFrame.Size = UDim2.new(0,190,1,0)
StickerFrame.BackgroundColor3 = Color3.fromRGB(25,25,25)
StickerFrame.BackgroundTransparency = 0.2
StickerFrame.BorderSizePixel = 0
StickerFrame.Visible = false
Instance.new("UICorner", StickerFrame).CornerRadius = UDim.new(0,10)

local StickerScroll = Instance.new("ScrollingFrame", StickerFrame)
StickerScroll.Size = UDim2.new(1,0,1,0)
StickerScroll.Position = UDim2.new(0,0,0,0)
StickerScroll.CanvasSize = UDim2.new(0,0,0,0)
StickerScroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
StickerScroll.ScrollBarImageTransparency = 1
StickerScroll.BorderSizePixel = 0
StickerScroll.BackgroundTransparency = 1
StickerScroll.ScrollingDirection = Enum.ScrollingDirection.Y
StickerScroll.ElasticBehavior = Enum.ElasticBehavior.Never
local scrollCorner = Instance.new("UICorner")
scrollCorner.CornerRadius = UDim.new(0,10)
scrollCorner.Parent = StickerScroll

local Grid = Instance.new("UIGridLayout")
Grid.Parent = StickerScroll
Grid.CellSize = UDim2.new(0,50,0,50)
Grid.CellPadding = UDim2.new(0,8,0,8)
Grid.HorizontalAlignment = Enum.HorizontalAlignment.Center

local Padding = Instance.new("UIPadding")
Padding.Parent = StickerScroll
Padding.PaddingTop = UDim.new(0,8)
Padding.PaddingBottom = UDim.new(0,8)
Padding.PaddingLeft = UDim.new(0,8)
Padding.PaddingRight = UDim.new(0,8)

StickerButton.MouseButton1Click:Connect(function()
	StickerFrame.Visible = not StickerFrame.Visible
end)

function AddFigurinha(id)
	local btn = Instance.new("ImageButton", StickerScroll)
	btn.Size = UDim2.new(0,50,0,50)
	btn.BackgroundTransparency = 1
	btn.Image = "rbxassetid://"..id
	btn.MouseButton1Click:Connect(function()
		InputBox:CaptureFocus()
		InputBox.Text ..= ":"..id..":"
		InputBox.CursorPosition = #InputBox.Text + 1
	end)
end

-- Figurinhas:



AddFigurinha(96479744307940) -- Eu fingindo que t√¥ entendendo tudo
AddFigurinha(84042465980408) -- Faz o L



local function notifyExternal(name, message, thumbnail)
	if not minimized then return end
	local hasSticker = message:match(":%d+:") ~= nil
	local cleanMessage = message:gsub(":%d+:", "")

	if hasSticker and cleanMessage:gsub("%s+", "") == "" then
	cleanMessage = "[Figurinha]"
elseif hasSticker then
	cleanMessage = "[Figurinha] " .. cleanMessage:gsub("^%s+", "")
end
	pcall(function()
		StarterGui:SetCore("SendNotification", {
			Title = name,
			Text = cleanMessage,
			Icon = thumbnail,
			Duration = 5
		})
	end)
end

local function parseMessage(container, text)
	local textOnly = text:gsub(":%d+:", "")
	if textOnly:gsub("%s+", "") ~= "" then
		local label = Instance.new("TextLabel", container)
		label.Size = UDim2.new(1,0,0,0)
		label.AutomaticSize = Enum.AutomaticSize.Y
		label.TextWrapped = true
		label.TextXAlignment = Enum.TextXAlignment.Left
		label.TextYAlignment = Enum.TextYAlignment.Top
		label.BackgroundTransparency = 1
		label.Font = Enum.Font.Gotham
		label.TextSize = 16
		label.TextColor3 = Color3.new(1,1,1)
		label.Text = parseRichText(textOnly)
        label.RichText = true
	end
	for id in text:gmatch(":(%d+):") do
		local img = Instance.new("ImageLabel", container)
		img.Size = UDim2.new(0,60,0,60)
		img.BackgroundTransparency = 1
		setSafeImage(img, id)
	end
end

local function createExternalMessage(name, message, thumbnail)
	notifyExternal(name, message, thumbnail)

	local MessageFrame = Instance.new("Frame", ChatArea)
	MessageFrame.Size = UDim2.new(1,-20,0,5)
	MessageFrame.BackgroundColor3 = Color3.fromRGB(30,30,30)
	MessageFrame.BorderSizePixel = 0
	MessageFrame.AutomaticSize = Enum.AutomaticSize.Y
	Instance.new("UICorner", MessageFrame).CornerRadius = UDim.new(0,8)

    local CopyButton = Instance.new("ImageButton", MessageFrame)
CopyButton.Size = UDim2.new(0,18,0,18)
CopyButton.Position = UDim2.new(1,-26,0,5)
CopyButton.BackgroundTransparency = 1
CopyButton.Image = "rbxassetid://139346215022591"
CopyButton.Name = "CopyButton"
CopyButton.AutoButtonColor = true
CopyButton.ZIndex = 5
CopyButton.MouseButton1Click:Connect(function()
	if setclipboard then
		setclipboard(message)
	end
end)

task.delay(165, function()
	if MessageFrame and MessageFrame.Parent then
		MessageFrame:Destroy()
	end
end)

	local Avatar = Instance.new("ImageLabel", MessageFrame)
	Avatar.Size = UDim2.new(0,36,0,36)
	Avatar.Position = UDim2.new(0,7,0,7)
	Avatar.BackgroundTransparency = 1
	Avatar.Image = thumbnail or ""

	local NameButton = Instance.new("TextButton", MessageFrame)
NameButton.Position = UDim2.new(0,50,0,5)
NameButton.Size = UDim2.new(1,-230,0,14)
NameButton.Text = name
NameButton.BackgroundTransparency = 1
NameButton.TextColor3 = Color3.fromRGB(255,255,255)
NameButton.Font = Enum.Font.GothamBold
NameButton.TextSize = 14
NameButton.TextXAlignment = Enum.TextXAlignment.Left
NameButton.AutoButtonColor = false
NameButton.ZIndex = 1

NameButton.MouseButton1Click:Connect(function()
	local mention = "@" .. name .. " "
	InputBox:CaptureFocus()

	if InputBox.Text == "" then
		InputBox.Text = mention
	else
		InputBox.Text = InputBox.Text .. mention
	end

	InputBox.CursorPosition = #InputBox.Text + 1
end)

	local Content = Instance.new("Frame", MessageFrame)
	Content.Position = UDim2.new(0,50,0,22)
	Content.Size = UDim2.new(1,-58,0,0)
	Content.AutomaticSize = Enum.AutomaticSize.Y
	Content.BackgroundTransparency = 1

	local ContentLayout = Instance.new("UIListLayout", Content)
	ContentLayout.Padding = UDim.new(0,6)

	parseMessage(Content, message)
	task.defer(function()
	MessageFrame.Size = UDim2.new(
		1,
		-10,
		0,
		Content.AbsoluteSize.Y + 30
	)
end)
end

local WebSocketLib = WebSocket
local connecting = false
local ws

local function connectWS()
	if connecting then return end
	connecting = true
	ws = WebSocketLib.connect("wss://eita1-production.up.railway.app")

	ws.OnMessage:Connect(function(msg)
		local data = HttpService:JSONDecode(msg)
		createExternalMessage(data.name, data.message, data.thumbnail)
	end)

	ws.OnClose:Connect(function()
		connecting = false
		task.wait(2)
		connectWS()
	end)
end

connectWS()

local function sendMessage(text)
	local thumb
	pcall(function()
		thumb = Players:GetUserThumbnailAsync(LocalPlayer.UserId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size150x150)
	end)
	if ws then
		pcall(function()
			ws:Send(HttpService:JSONEncode({
				name = LocalPlayer.Name,
				thumbnail = thumb,
				message = text
			}))
		end)
	end
end

SendButton.MouseButton1Click:Connect(function()
	if InputBox.Text == "" then return end
	startSendingAnimation()
	local text = InputBox.Text
	InputBox.Text = ""
	task.spawn(function()
		sendMessage(text)
		stopSendingAnimation()
	end)
end)